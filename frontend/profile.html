<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">My Profile</h2>
    <div id="profile" class="card p-3 shadow-sm">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Username:</strong> <span id="u-username">-</span></p>
          <p><strong>Email:</strong> <span id="u-email">-</span></p>
          <p><strong>Role:</strong> <span id="u-role">-</span></p>
          <p><strong>Email Verified:</strong> <span id="u-verified">-</span></p>
        </div>
        <div class="col-md-6">
          <div id="verify-block" class="border rounded p-3">
            <h6>Email Verification</h6>
            <div class="d-flex gap-2 mb-2">
              <input type="email" class="form-control" id="email-input" placeholder="Update email (optional)" />
              <button class="btn btn-secondary" onclick="updateEmail()">Save</button>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary" onclick="sendCode()">Send Code</button>
              <input class="form-control" id="code-input" placeholder="Enter 6-digit code" maxlength="6" />
              <button class="btn btn-success" onclick="verifyCode()">Verify</button>
            </div>
            <div id="msg" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  const API = 'http://127.0.0.1:8000';
  const token = localStorage.getItem('access');
  if(!token){ window.location.href = 'login.html'; }

  function setMsg(text, type='info'){ document.getElementById('msg').innerHTML = `<div class="alert alert-${type}">${text}</div>`; }

  async function loadMe(){
    const res = await fetch(`${API}/api/auth/me/`, { headers:{ 'Authorization':'Bearer '+token } });
    const data = await res.json();
    if(!res.ok){ setMsg(data.detail || 'Failed to fetch profile', 'danger'); return; }
    document.getElementById('u-username').textContent = data.username;
    document.getElementById('u-email').textContent = data.email || '(not set)';
    document.getElementById('u-role').textContent = data.role;
    document.getElementById('u-verified').textContent = data.is_email_verified ? 'Yes' : 'No';
    document.getElementById('email-input').value = data.email || '';
  }

  async function updateEmail(){
    const email = document.getElementById('email-input').value.trim();
    if(!email){ setMsg('Enter a valid email first', 'warning'); return; }
    // minimal email update via DRF: PATCH /api/auth/me/ not implemented; show guidance
    setMsg('Update email from backend or add PATCH endpoint. For now, set email when registering.', 'warning');
  }

  async function sendCode(){
    const res = await fetch(`${API}/api/auth/send-code/`, { method:'POST', headers:{ 'Authorization':'Bearer '+token } });
    const data = await res.json();
    if(!res.ok){ setMsg(data.detail || 'Failed to send code', 'danger'); return; }
    setMsg('Verification code sent to your email');
  }

  async function verifyCode(){
    const code = document.getElementById('code-input').value.trim();
    if(code.length !== 6){ setMsg('Enter the 6-digit code', 'warning'); return; }
    const res = await fetch(`${API}/api/auth/verify-code/`, { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({code}) });
    const data = await res.json();
    if(!res.ok){ setMsg(data.detail || 'Verification failed', 'danger'); return; }
    setMsg('Email verified!', 'success');
    loadMe();
  }

  loadMe();
  </script>
</body>
</html>

