<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Dashboard</h3>
      <div>
        <a class="btn btn-outline-secondary" href="analysis.html">Analytics</a>
        <a class="btn btn-outline-secondary" href="profile.html">Profile</a>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted">Total Predictions</div>
            <div class="display-6" id="t-pred">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted">Labeled</div>
            <div class="display-6" id="t-labeled">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted">Labeled Accuracy</div>
            <div class="display-6" id="t-acc">-</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12">
        <canvas id="dailyChart" height="120"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="predDist" height="200"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="actDist" height="200"></canvas>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://127.0.0.1:8000';
    const token = localStorage.getItem('access');

    if (!token) {
      window.location.href = 'login.html';
    }

    async function loadDash() {
      try {
        const res = await fetch(`${API}/api/predictions/dashboard/`, {
          headers: {
            Authorization: 'Bearer ' + token,
          },
        });

        if (!res.ok) {
          const errorData = await res.json();
          console.warn('Dashboard error:', errorData);
          return;
        }

        const data = await res.json();

        document.getElementById('t-pred').textContent =
          data.totals?.predictions ?? '-';
        document.getElementById('t-labeled').textContent =
          data.totals?.labeled ?? '-';
        document.getElementById('t-acc').textContent =
          data.labeled_accuracy != null
            ? `${(data.labeled_accuracy * 100).toFixed(1)}%`
            : '-';

        const dates = (data.daily_counts || []).map((d) => d.date);
        const counts = (data.daily_counts || []).map((d) => d.count);

        new Chart(document.getElementById('dailyChart'), {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'Daily predictions',
                data: counts,
                borderColor: '#4e79a7',
                fill: false,
                tension: 0.1,
              },
            ],
          },
          options: { responsive: true },
        });

        const keys = ['Win', 'Draw', 'Loss'];
        const pred = data.distribution?.predicted || {};
        const act = data.distribution?.actual || {};

        new Chart(document.getElementById('predDist'), {
          type: 'doughnut',
          data: {
            labels: keys,
            datasets: [
              {
                data: keys.map((k) => pred[k] || 0),
                backgroundColor: ['#59a14f', '#edc948', '#b07aa1'],
              },
            ],
          },
          options: { responsive: true },
        });

        new Chart(document.getElementById('actDist'), {
          type: 'doughnut',
          data: {
            labels: keys,
            datasets: [
              {
                data: keys.map((k) => act[k] || 0),
                backgroundColor: ['#4e79a7', '#f28e2b', '#e15759'],
              },
            ],
          },
          options: { responsive: true },
        });
      } catch (error) {
        console.error('Failed to load dashboard:', error);
      }
    }

    loadDash();
  </script>
</body>
</html>
